<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vibe Survivor â€“ Progression</title>
<style>
html, body {
  margin: 0;
  height: 100%;
  background: radial-gradient(circle, #020617, #000);
  font-family: system-ui, sans-serif;
  color: white;
  overflow: hidden;
}

#hud {
  position: fixed;
  top: 15px;
  left: 15px;
  font-size: 16px;
}

#shop {
  position: fixed;
  right: 15px;
  top: 15px;
  background: rgba(0,0,0,0.6);
  padding: 12px;
  border-radius: 10px;
  width: 230px;
}

.shop-item {
  margin-bottom: 10px;
  cursor: pointer;
  opacity: 0.85;
}
.shop-item:hover { opacity: 1; }

#gameover {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  background: rgba(0,0,0,0.75);
  font-size: 26px;
}

button {
  margin-top: 20px;
  padding: 10px 18px;
  font-size: 18px;
  cursor: pointer;
}

canvas { display: block; }
</style>
</head>
<body>

<div id="hud">
  Score: <span id="score">0</span><br>
  Misses: <span id="misses">0</span>/<span id="missCap">5</span><br>
  Vibes: <span id="vibes">0</span>
</div>

<div id="shop">
  <b>Upgrades</b><br><br>
  <div class="shop-item" onclick="buy('size')">
    ðŸŸ¢ Bigger Orbs<br>
    Level: <span id="sizeLv">0</span> (Cost: <span id="sizeCost">10</span>)
  </div>
  <div class="shop-item" onclick="buy('life')">
    ðŸ”µ Longer Life<br>
    Level: <span id="lifeLv">0</span> (Cost: <span id="lifeCost">10</span>)
  </div>
  <div class="shop-item" onclick="buy('combo')">
    ðŸŸ£ Combo Boost<br>
    Level: <span id="comboLv">0</span> (Cost: <span id="comboCost">15</span>)
  </div>
  <div class="shop-item" onclick="buy('forgive')">
    ðŸŸ¡ Miss Buffer<br>
    Level: <span id="forgiveLv">0</span> (Cost: <span id="forgiveCost">20</span>)
  </div>
</div>

<div id="gameover">
  <div id="final"></div>
  <button onclick="restart()">Next Run</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

// ---- GAME STATE ----
let score = 0;
let misses = 0;
let vibes = 0;
let spawnRate = 1200;
let running = true;
let orbs = [];
let combo = 0;

// ---- UPGRADES ----
const upgrades = {
  size: { lv: 0, base: 10 },
  life: { lv: 0, base: 10 },
  combo: { lv: 0, base: 15 },
  forgive: { lv: 0, base: 20 }
};

function cost(u) {
  return upgrades[u].base * (upgrades[u].lv + 1);
}

function buy(u) {
  const c = cost(u);
  if (vibes >= c) {
    vibes -= c;
    upgrades[u].lv++;
    updateUI();
  }
}

function updateUI() {
  scoreEl.textContent = score;
  missesEl.textContent = misses;
  vibesEl.textContent = vibes;
  missCapEl.textContent = 5 + upgrades.forgive.lv;

  for (let u in upgrades) {
    document.getElementById(u + "Lv").textContent = upgrades[u].lv;
    document.getElementById(u + "Cost").textContent = cost(u);
  }
}

const scoreEl = document.getElementById("score");
const missesEl = document.getElementById("misses");
const missCapEl = document.getElementById("missCap");
const vibesEl = document.getElementById("vibes");

// ---- AUDIO ----
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function tone(freq) {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  g.gain.value = 0.001;
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.25);
}

// ---- SPAWN ----
function spawnOrb() {
  if (!running) return;

  const baseLife = 900 + upgrades.life.lv * 150;

  orbs.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: 26 + upgrades.size.lv * 4,
    born: performance.now(),
    life: baseLife
  });

  spawnRate = Math.max(350, spawnRate - 6);
  setTimeout(spawnOrb, spawnRate);
}
spawnOrb();

// ---- INPUT ----
canvas.addEventListener("pointerdown", e => {
  if (audioCtx.state === "suspended") audioCtx.resume();

  const x = e.clientX;
  const y = e.clientY;

  for (let i = orbs.length - 1; i >= 0; i--) {
    const o = orbs[i];
    if (Math.hypot(o.x - x, o.y - y) < o.r) {
      orbs.splice(i, 1);
      combo++;
      const gain = 1 + combo * 0.1 * upgrades.combo.lv;
      score += Math.floor(gain);
      vibes++;
      tone(300 + combo * 15);
      updateUI();
      return;
    }
  }
});

// ---- LOOP ----
function loop(t) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  orbs.forEach((o, i) => {
    const age = t - o.born;
    const pct = age / o.life;

    if (pct >= 1) {
      orbs.splice(i, 1);
      misses++;
      combo = 0;
      tone(100);
      updateUI();
      if (misses >= 5 + upgrades.forgive.lv) endGame();
      return;
    }

    ctx.fillStyle = `hsl(${score * 6 % 360},80%,60%)`;
    ctx.beginPath();
    ctx.arc(o.x, o.y, o.r, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = "white";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(o.x, o.y, o.r + 6,
      -Math.PI/2,
      -Math.PI/2 + Math.PI * 2 * (1 - pct));
    ctx.stroke();
  });

  if (running) requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ---- GAME OVER ----
const gameoverEl = document.getElementById("gameover");
const finalEl = document.getElementById("final");

function endGame() {
  running = false;
  finalEl.textContent = `Run Score: ${score}`;
  gameoverEl.style.display = "flex";
}

function restart() {
  score = 0;
  misses = 0;
  combo = 0;
  orbs = [];
  spawnRate = 1200;
  running = true;
  gameoverEl.style.display = "none";
  updateUI();
  spawnOrb();
  requestAnimationFrame(loop);
}

updateUI();
</script>

</body>
</html>
